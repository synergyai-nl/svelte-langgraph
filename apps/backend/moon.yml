# https://moonrepo.dev/docs/config/project
$schema: "https://moonrepo.dev/schemas/project.json"

language: python
stack: backend
type: application

fileGroups:
  sources:
    - 'src/**/*'
    # Configs
    - '**/*.config.*'
    # Other files
    - '**/*.{md,mdx,yml,yaml,json}'
  tests:
    - 'tests/**/*'
    - 'e2e/**/*'

tasks:
  setup:
    # Used by E2E to ensure dependencies are installed before starting backend server and mocks.
    command: noop
  format:
    command: "ruff format"
    args: "--check"
    inputs:
      - '@group(sources)'
      - '@group(tests)'
  format-write:
    command: "ruff format"
    local: true
  lint:
    command: "ruff check"
    inputs:
      - '@group(sources)'
      - '@group(tests)'
  lint-fix:
    extends: lint
    args: "--fix"
    local: true
  typecheck:
    command: "pyright"
    inputs:
      - '@group(sources)'
      - '@group(tests)'
  oidc-mock:
    command: "oidc-provider-mock --port 8080 --host localhost --user test-user"
    preset: "server"
    local: true
  dev:
    command: 'langgraph dev'
    args:
     - '--no-browser'
     - '--host localhost'
    preset: "watcher"
    options:
      envFile: '/.env'
  serve-e2e:
    extends: dev
    args:
      - '--no-reload'
    options:
      envFile: '/.env.e2e'
    preset: "server"
  build:
    command: "langgraph build --tag svelte-langgraph-backend --pull"
    deps:
      - lint
      - typecheck
  up:
    command: "langgraph up"
    preset: "server"
    deps:
      - build
    options:
      envFile: '/.env'
  test:
    command: "pytest"
    args: 
      - "-v"
    inputs:
      - '@group(sources)'
      - '@group(tests)'
    options:
      outputStyle: "stream"
  test-cov:
    extends: test
    args: 
      - "--cov=svelte_langgraph --cov-branch --cov-report lcov --cov-report term --cov-report html"
