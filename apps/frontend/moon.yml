$schema: 'https://moonrepo.dev/schemas/project.json'

language: typescript
stack: frontend
type: application

fileGroups:
  sources:
    - 'src/**/*'
    # Configs
    - '**/*.config.*'
    # Other files
    - '**/*.{md,mdx,yml,yaml,json}'
  tests:
    - 'tests/**/*'
    - 'e2e/**/*'
  messages:
    - 'project.inlang'
    - 'messages'

tags: ['vite', 'vitest', 'sveltekit']

tasks:
  build:
    inputs:
      - '@group(sources)'
      - '@group(messages)'
    outputs:
      - 'build'
      - 'src/lib/paraglide'
    options:
      retryCount: 1

  check:
    deps:
      - build

  lint:
    command: eslint .
    inputs:
      - '@group(messages)'
      - '@group(sources)'
      - '@group(tests)'
      # Root configs, any format
      # - '/eslint.config.js'

  lint-fix:
    extends: lint
    args:
      - '--cache'
      - '--fix'
    local: true

  format:
    command: prettier
    inputs:
      - '@group(messages)'
      - '@group(sources)'
      - '@group(tests)'
      - '.prettierignore'
      - '.prettierrc'
      # Root configs, any format
      # - '/.prettierignore'
      # - '/.prettierrc'
    args:
      - '.'
      - '--check'

  format-write:
    extends: format
    args:
      - '.'
      - '--cache'
      - '--write'
    local: true
    options:
      mergeArgs: 'replace'

  install-playwright:
    command: npx playwright install chromium --with-deps
    options:
      internal: true
    inputs:

  test:
    args:
      - '--silent'
      - 'passed-only'

  test-cov:
    args:
      - '--coverage.reporter text --coverage.reporter lcov'
      - '--coverage.include src'
      - '--coverage.exclude "**/*.(test|spec).*" --coverage.exclude src/lib/paraglide'

  test-e2e:
    command: playwright test
    deps:
      - build
      - install-playwright
    options:
      retryCount: 1

  dev:
    options:
      envFile: '/.env'

  serve-e2e:
    extends: preview
    options:
      envFile: '/.env.e2e'
